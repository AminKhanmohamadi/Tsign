{% extends '_base.html' %}
{% block title %} Library {% endblock %}
{% block content %}
    <div class="row mb-5 p-3">
        <div class="col">
            <!-- Breadcrumb -->
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="{% url 'folder_list' %}">Home</a>
                    </li>
                    {% for folder in breadcrumbs %}
                        <li class="breadcrumb-item">
                            <a href="{% url 'folder_list' %}?folder={{ folder.id }}"
                            >{{ folder.name }}</a
                            >
                        </li>
                    {% endfor %}
                </ol>
            </nav>
        </div>
        <div class="col text-end">
            <button
                    class="btn btn-primary"
                    data-bs-toggle="modal"
                    data-bs-target="#uploadModal"
            >
                <i class="bi bi-upload"></i> Upload File
            </button>

            <button
                    class="btn btn-success"
                    data-bs-toggle="modal"
                    data-bs-target="#newFolderModal"
            >
                <i class="bi bi-folder-plus"></i>Create Folder
            </button>
        </div>
    </div>

    <div class="row g-4 card">
        <!-- Folders -->
        <div class="table-responsive">
            <div class="mt-40">
                <div class="px*30 py-20 bg-light rounded-5">
                    <div class="row">
                        <div class="col-lg-3 col-sm-12">
                            <div class="text-light-1">Name</div>
                        </div>
                        <div class="col-lg-2 col-sm-4 mt-sm-10">
                            <div class="text-light-1">cerated</div>
                        </div>
                        <div class="col-lg-2 col-sm-2 mt-sm-10">
                            <div class="text-light-1">Delete/Update</div>
                        </div>

                        <div class="col-lg-1 col-sm-2 mt-sm-10">
                            <div class="text-light-1">Size</div>
                        </div>
                        <div class="col-lg-1 col-sm-2 mt-sm-10">
                            <div class="text-light-1">Type</div>
                        </div>
                        <div class="col-lg-2 col-sm-2 mt-sm-10">
                            <div class="text-light-1">More</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {% for folder in folders %}
            <div class="col-md-12">
                <div class="folder-card h-100">
                    <div class="card-body row text-left pt-2">
                        <div class="col-lg-3 col-sm-12">
                            <i class="bi bi-folder-fill folder-icon"></i>
                            <h5 class="card-title mt-2">{{ folder.name }}</h5>
                            <p class="text-muted small">{{ folder.files.count }} items</p>
                        </div>
                        <div class="col-lg-2">{{ folder.datetime_created|date:"Y/m/d" }}</div>
                        <div class="col-lg-2">
                            <div class="btn-group">
                                <button
                                        class="btn btn-sm btn-warning rename-folder"
                                        data-bs-toggle="modal"
                                        data-bs-target="#renamefModal"
                                        data-id="{{ folder.id }}"
                                        data-name="{{ folder.name }}"
                                >
                                    <i class="bi bi-pencil"></i>
                                </button>

                                <button class="btn btn-sm btn-danger delete-folder"
                                        data-id="{{ folder.id }}"
                                        data-url="{% url 'delete_folder' folder.id %}">
                                    <i class="bi bi-trash"></i>
                                </button>

                            </div>
                        </div>
                        <div class="col-lg-1 col-sm-2 mt-sm-10"></div>
                        <div class="col-lg-1 col-sm-2 mt-sm-10"></div>
                        <div class="col-lg-2">
                            <div class="btn-group">
                                <a
                                        href="{% url 'folder_list' %}?folder={{ folder.id }}"
                                        class="btn btn-sm btn-primary"
                                >
                                    <i class="bi bi-folder2-open"></i>Open
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}

        <!-- Files -->
        {% for file in files %}
            <div class="col-md-12 mt-5">
                <div class="file-card h-100">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-lg-3 col-sm-12">
                                {% if file.file_type == 'image' %}
                                    <img
                                            src="{{ file.file.url }}"
                                            class="thumbnail"
                                            alt="{{ file.name }}"
                                    />
                                {% elif file.file_type == 'video' %}
                                    <video class="thumbnail" autoplay muted loop></video>
                                {% endif %}
                                <h5 class="card-title mt-2">{{ file.name }}</h5>
                            </div>
                            <div class="col-lg-2">{{ file.datetime_created|date:"Y/m/d" }}</div>
                            <div class="col-lg-2">
                                <div class="btn-group">
                                    <button
                                            class="btn btn-warning rename-file"
                                            data-bs-toggle="modal"
                                            data-bs-target="#renameFileModal"
                                            data-id="{{ file.id }}"
                                            data-name="{{ file.name }}"
                                    >
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger delete-file"
                                            data-id="{{ file.id }}"
                                            data-url="{% url 'delete_file' file.id %}">
                                        <i class="bi bi-trash"></i>
                                    </button>

                                </div>
                            </div>

                            <div class="col-lg-1">
                                <p class="text-muted small">{{ file.size|filesizeformat }}</p>
                            </div>
                            <div class="col-lg-1">
                                <p class="text-muted small">{{ file.get_file_type_display }}</p>
                            </div>
                            <div class="col-lg-2">
                                <div class="btn-group w-50">
                                    <button
                                            class="btn btn-sm btn-primary view-file"
                                            data-bs-toggle="modal"
                                            data-bs-target="#fileDetailsModal"
                                            data-name="{{ file.name }}"
                                            data-type="{{ file.get_file_type_display }}"
                                            data-size="{{ file.size|filesizeformat }}"
                                            data-date="{{ file.datetime_created|date:'Y/m/d' }}"
                                            data-url="{{ file.file.url }}"
                                    >
                                        <i class="bi bi-eye"></i> نمایش
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>

    <!-- Modal ٰView File -->
    <div class="modal fade"
         id="fileDetailsModal"
         tabindex="-1"
         aria-labelledby="fileDetailsModalLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="fileDetailsModalLabel">File Detail</h5>
                    <button
                            type="button"
                            class="btn-close"
                            data-bs-dismiss="modal"
                            aria-label="Close"
                    ></button>
                </div>
                <div class="modal-body">
                    <h5>Name: <span id="fileName"></span></h5>
                    <p>Type: <span id="fileType"></span></p>
                    <p>Size: <span id="fileSize"></span></p>
                    <p>Created: <span id="fileDate"></span></p>

                    <div id="filePreview" class="mt-3"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete File Modal -->
    <div class="modal fade" id="deleteFileModal" tabindex="-1" aria-labelledby="deleteFileModalLabel"
         aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteFileModalLabel">حذف فایل</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    آیا مطمئن هستید که می‌خواهید این فایل را حذف کنید؟
                </div>
                <div class="modal-footer">
                    <form id="deleteFileForm" method="post">
                        {% csrf_token %}
                        <input type="hidden" id="file_id" name="file_id" value="">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">لغو</button>
                        <button type="submit" class="btn btn-danger">حذف</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Confirm Delete -->
    <div class="modal fade" id="deleteFolderModal" tabindex="-1" aria-labelledby="deleteFolderModalLabel"
         aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteFolderModalLabel">حذف فایل</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    آیا مطمئن هستید که می‌خواهید این فولدر را حذف کنید؟
                </div>
                <div class="modal-footer">
                    <form id="deleteFolderForm" method="post">
                        {% csrf_token %}
                        <input type="hidden" id="folder_id" name="folder_id" value="">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">لغو</button>
                        <button type="submit" class="btn btn-danger">حذف</button>
                    </form>
                </div>
            </div>
        </div>
    </div>



    {% include 'core/partial/folder_create.html' %}
    {% include 'core/partial/file_upload.html' %}
    {% include 'core/partial/file_update_name.html' %}
    {% include 'core/partial/folder_update_name.html' %}
{% endblock %}

{% block exterajs %}
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // گرفتن دکمه‌های تغییر نام پوشه
            const renameButtons = document.querySelectorAll('.rename-folder');
            renameButtons.forEach(button => {
                button.addEventListener('click', function () {
                    const folderId = this.getAttribute('data-id');
                    const folderName = this.getAttribute('data-name');

                    // پر کردن فرم با اطلاعات پوشه
                    document.getElementById('folder_id').value = folderId;
                    document.getElementById('folder_name').value = folderName;
                });
            });

            // ارسال فرم تغییر نام پوشه
            const renameForm = document.getElementById('renameFolderForm');
            if (renameForm) {
                renameForm.addEventListener('submit', function (event) {
                    event.preventDefault();

                    const folderId = document.getElementById('folder_id').value;
                    const newName = document.getElementById('folder_name').value;

                    // ارسال درخواست AJAX به سرور
                    fetch("{% url 'folder_update_name' %}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',  // ارسال داده‌ها به صورت JSON
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        },
                        body: JSON.stringify({  // ارسال داده‌ها به صورت JSON
                            folder_id: folderId,
                            name: newName
                        })
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // بستن مدال
                                var myModal = new bootstrap.Modal(document.getElementById('renamefModal'));
                                myModal.hide();

                                // بارگذاری مجدد صفحه برای مشاهده تغییرات
                                location.reload();
                            } else {
                                alert('Failed to update folder: ' + data.message);
                            }
                        })
                        .catch(error => {
                            console.error("Error:", error);
                            alert("An error occurred while updating the folder.");
                        });
                });
            }
        });
        document.addEventListener("DOMContentLoaded", function () {
            // گرفتن دکمه‌های تغییر نام فایل
            const renameFileButtons = document.querySelectorAll('.rename-file');
            renameFileButtons.forEach(button => {
                button.addEventListener('click', function () {
                    const fileId = this.getAttribute('data-id');
                    const fileName = this.getAttribute('data-name');

                    // پر کردن فرم با اطلاعات فایل
                    document.getElementById('file_id').value = fileId;
                    document.getElementById('file_name').value = fileName;
                });
            });

            // ارسال فرم تغییر نام فایل
            const renameFileForm = document.getElementById('renameFileForm');
            if (renameFileForm) {
                renameFileForm.addEventListener('submit', function (event) {
                    event.preventDefault();

                    const fileId = document.getElementById('file_id').value;
                    const newName = document.getElementById('file_name').value;

                    // ارسال درخواست AJAX به سرور
                    fetch("{% url 'file_update' %}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',  // ارسال داده‌ها به صورت JSON
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        },
                        body: JSON.stringify({  // ارسال داده‌ها به صورت JSON
                            file_id: fileId,
                            name: newName
                        })
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // بستن مدال
                                var myModal = new bootstrap.Modal(document.getElementById('renameFileModal'));
                                myModal.hide();

                                // بارگذاری مجدد صفحه برای مشاهده تغییرات
                                location.reload();
                            } else {
                                alert('Failed to update file: ' + data.message);
                            }
                        })
                        .catch(error => {
                            console.error("Error:", error);
                            alert("An error occurred while updating the file.");
                        });
                });
            }
        });
    </script>
{% endblock %}
